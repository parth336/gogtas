<div class="sb__sec">
  <div class="sb__sec__btn">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-user-popup">
      <span class="icon-add-circle"></span>
      Add User</button>
    <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#import-user-popup">
      <span class="icon-profile-add"></span>
      Import User</button>
  </div>
</div>
<table id="users-table" class="display" style="width:100%">
  <thead>
    <tr>
      <th class="t-user-name">Name</th>
      <th class="t-email">Email</th>
      <th class="t-status">Status</th>
    </tr>
  </thead>
  <tbody>
    <% for(var x=0 ; x<users.length ; x++) {%>
    <tr>
      <td class="t-user-name"><%= users[x].firstname %> <%= users[x].lastname %></td>
      <td class="t-email"><%= users[x].email %></td>
      <td class="t-status">
        <% if(users[x].status) { %>
          <a class="status-item status-item--active">
        <% } else { %>
          <a class="status-item">
        <% } %>
        </a>
      </td>
    </tr>
  <% } %>
  </tbody>
  <tfoot>
    <tr>
      <th class="t-user-name">Name</th>
      <th class="t-email">Email</th>
      <th class="t-status">Status</th>
    </tr>
  </tfoot>
</table>
<div id="emptyUsers" class="add-institute-empty-inner">
    <div class="img-inner img-add-inner">
        <img src="../assets/images/add-user-img.png" alt="">

        <h3>Add User</h3>
        <p>Lorem ipsum is placeholder text commonly used in the <br> graphic, print, and publishing industrie.</p>
    </div>
</div>

<div class="modal fade" id="import-user-popup" tabindex="-1" aria-labelledby="importUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Import User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="from-inner">
            <form class="needs-validation" action="/institute/importUser" method="post" enctype="multipart/form-data">
                  <div class="row">
                    <div class="col-lg-12">
                      <input type="search" class="search" placeholder="Search" aria-controls="institute-table" autocomplete="off">
                    </div>
                    <div class="col-lg-12 drop">
                      <div class="file-drop-area"> 
                        <h3>Drang & Drop file here to upload</h3>
                        <p><span>OR</span></p>
                        <div class="file-input-btn">
                          <input class="file-input" type="file" accept=".csv" required>
                        <button type="submit" class="btn btn-primary">Browse files</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
                </div>
        </div>
        
      </div>
    </div>
  </div>


  <div class="modal fade" id="add-user-popup" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
          <button type="button" class="btn-close" id="closeAdduser" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="from-inner">
              <form id="addUserForm" class="needs-validation">
                  <div class="row">
                    <div class="col-lg-6">
                      <label class="form-label">First Name</label>
                      <input type="text" class="form-control" data-provide="typeahead" id="firstname" placeholder="First Name" autocomplete="off" >
                    </div>
                    <div class="col-lg-6">
                      <label class="form-label">Last Name</label>
                      <input id="lastname" class="form-control" type="text" placeholder="Last Name" >
                    </div>
                    
                    <div class="col-lg-12">
                      <label class="form-label">Email</label>
                      <input id="email" class="form-control" type="text" placeholder="Email" >
                    </div>
                    
                  </div>
  
                  <div class="form-btn">
                    <button type="submit" class="btn btn-primary">Add User</button>
                  </div>
                </form>
                </div>
        </div>
        
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script>
  
   $(document).ready(function() {
    
    $('#users-table').DataTable( {
        "dom": '<"top"f>rt<"bottom"lp><"clear">',
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search"
        }
    } );
    let usersCount = "<%= users.length %> "
    if(Number(usersCount) > 0){
      $("#emptyUsers").hide();
    }else{
      $('#users-table').parents('div.dataTables_wrapper').first().hide();
    }
  } );

  const validateEmail = (email) =>{
    return email.match(
      /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
    );
  };

    $(document).on('change', '.file-input', function() {

      var filesCount = $(this)[0].files.length;

      var textbox = $(this).prev();

      if (filesCount === 1) {
        var fileName = $(this).val().split('\\').pop();
        textbox.text(fileName);
      } else {
        textbox.text(filesCount + ' files selected');
      }
    });

    function checkEmpty(ele){
    if(ele.val() == ""){
      ele.addClass("is-invalid");
      ele.removeClass("is-valid");
      return false;
    }else{
      ele.addClass("is-valid");
      ele.removeClass("is-invalid");
      return true;
    }
  }
  function checkEmail(){
    let email = $("#email");
    let emailCheck = validateEmail(email.val());
    if(!emailCheck){
      email.addClass("is-invalid");
      return false;
    }else{
      email.addClass("is-valid");
      return true;
    }
  }

  $("#addUserForm").submit( function (e){
    e.preventDefault();
    e.stopPropagation();
    let firstName = $("#firstname");
    let lastname = $("#lastname");
    if(checkEmpty(firstName) && checkEmpty(lastname) && checkEmail()){
      let formData = {}
      var url = window.location.pathname;
      var id = url.substring(url.lastIndexOf('/') + 1);
      formData.firstname = $("#firstname").val();
      formData.lastname = $("#lastname").val();
      formData.email = $("#email").val();
      formData.institute = id;
      $.post("/institute/addUser",formData).done(()=>{
        $.alert("User added successfully.");
        console.log("user added successfully!")
        window.location.reload();
      })
    }
  })

  
  </script>